---
- name: Déploiement de l'application avec Docker Compose
  hosts: noep@noe-philippe.fr

  tasks:
    - name: Créer le répertoire fast-foodie s'il n'existe pas
      become_user: noep
      file:
        path: ~/fast-foodie
        state: directory
      register: create_directory_result
      ignore_errors: yes

    - name: Copier le fichier docker-compose.api.yml
      become_user: noep
      copy:
        src: docker-compose.api.yml
        dest: ~/fast-foodie/docker-compose.api.yml
      register: copy_docker_compose_result
      ignore_errors: yes

    - name: Copier le fichier .env.production
      become_user: noep
      copy:
        src: .env.production
        dest: ~/fast-foodie/.env
      register: copy_env_result
      ignore_errors: yes

    - name: Arrêter le service Docker
      become_user: noep
      command: docker compose -f ~/fast-foodie/docker-compose.api.yml down
      ignore_errors: yes

    - name: Pull de l'image Docker
      become_user: noep
      command: docker pull noephilippe/fast-foodie-api:latest
      ignore_errors: yes

    - name: Démarrer Docker Compose
      become_user: noep
      command: docker compose -f ~/fast-foodie/docker-compose.api.yml up -d
      register: docker_compose_result
      ignore_errors: yes

    - name: 'Nettoyage des images Docker'
      become_user: noep
      command: 'docker image prune -f'
      ignore_errors: yes
